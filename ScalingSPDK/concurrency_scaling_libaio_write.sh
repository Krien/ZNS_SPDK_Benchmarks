#!/bin/bash

DIR=$(cd $(dirname "${BASH_SOURCE[0]}") && pwd)
cd $DIR

if ! command -v fio &> /dev/null
then
    echo "Please add fio to your path"
    exit 1
fi

if [ -z SPDK_DIR ]; then
    echo "Please provide a path to the SPDK_DIR"
    exit 1
fi


if [[ "$#" -ne 1 ]]; then
    echo "Please add a device name and namespace"
    exit 1
fi

# Parse input
devs=( $(echo "$1" | awk 'BEGIN{FS=" ";OFS="\n"}{$1=$1}1') )

# Verify devs
for dev in "${devs[@]}"; do
 if $(ls "/sys/block/$dev/device/device" > /dev/null 2>&1 ); then
    echo "using /dev/$dev"
 else
    echo "Not a valid device: /sys/block/dev/$dev/device/device"
    exit 1
 fi
done

# Create FIO test
#define job
jobname="./concurrency_write_autogenerated.fio"
jobglob=$(cat <<'EOF'
# This file is autogenerated, do not alter
[global]
ioengine=libaio
thread=1
group_reporting=1
direct=1
time_based=1
ramp_time=5
runtime=60
size=128z
rw=write
iodepth=1
zonemode=zbd
max_open_zones=14
bs=4096
EOF
)
jobworker=$(cat <<'EOF'
offset_increment=128z
numjobs=14
EOF
)
echo "$jobglob" > $jobname
for i in "${!devs[@]}"; do
    echo "" >> $jobname
    echo "[${devs[i]}]" >> $jobname
    echo "filename=/dev/${devs[i]}" >> $jobname
    echo "$jobworker" >> $jobname
done

fio "$jobname"
